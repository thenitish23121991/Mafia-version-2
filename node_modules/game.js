
var db = require('db');
var games = db.games;
var users = db.users;


function get_random(max){
var max1 = max+1;
var num = Math.floor(Math.random()*max1);
num = num-1;
return num;
}


function set_player_role(game,player_name,role){
var set_role;
var result11111 = games.find({name:game});
result11111.on('complete',function(err1,docs1){
docs1[0].users.forEach(function(element,index){
if(docs1[0].users.name == player_name){
set_role = docs1[0].users.role;
}
});
if(set_role == 'player' && set_role == 'host'){
var result121 = games.update({"users.name":player_name},{$set:{"users.$.role":role}});
result121.on('complete',function(err,docs){
console.log('player: '+player_name+'/role: '+role);
});
}else{
set_player_role(game,player_name,role);
}
});
}

function get_game_info(game,callback){
var game1 = games.find({name:game});
game1.on('complete',function(err,docs){
callback(docs);
});
}

function get_role_count(game,role,callback){
var role_count;
var result1 = games.find({name:game},{users:{$elemMatch:{role:role}}});
result1.on('complete',function(err,docs){
callback(docs);
});
}

function assign_mafias(game,callback){
global.count1 = 0;
var get_game = get_game_info(game,function(docs1){
console.log('get game: '+docs1[0].users[0].name);

var game_users = docs1[0].users;
var total_mafias = get_role_count(game,'mafia',function(docs){

var game_users = docs[0].users;
game_users.forEach(function(element,index){
if(total_mafias == 'mafia'){
global.count1 = global.count1+1;
}
});
console.log('outside: '+global.count1);

if(global.count1 <= 3){
var num1 = get_random();
console.log(num1);
var player = game_users[num1].name;
set_player_role(game,player,'mafia');
callback('again');

}else{
callback('done');
}

});


});
}


function assign_citizens(game){
global.citizen_count1 = 0;
var get_game = get_game_info(game,function(docs1){
//console.log('get game: '+docs1[0].users[0].name);

var game_users = docs1[0].users;
var total_mafias = get_role_count(game,'citizen',function(docs){

var game_users = docs[0].users;
game_users.forEach(function(element,index){
if(game_users[index].role == 'citizen'){
global.citizen_count1 = global.citizen_count1+1;
}
});

if(global.citizen_count1 < 3){
var num1 = get_random();
console.log('citizen count: '+global.citizen_count1);
var player = game_users[num1].name;
set_player_role(game,player,'citizen');


}else{
callback('done');
}

});


});
}

function assign_healer(game,users){
var total_healers = get_player_role(game,'healer',function(h1){
if(total_healers >= 1){
var num1 = get_random();
var player = users[num1];
set_player_role(game,player,'healer',function(data11){
assign_citizens();
});
}else{
return;
}
});
}

function assign_detective(game,users){
var total_healers = get_player_role(game,'detective',function(h1){
if(total_healers >= 1){
var num1 = get_random();
var player = users[num1];
set_player_role(game,player,'detective',function(data11){
assign_detective();
});
}else{
return;
}
});
}

function assign_dacoit(game,users){
var total_healers = get_player_role(game,'dacoit',function(h1){
if(total_healers >= 1){
var num1 = get_random();
var player = users[num1];
set_player_role(game,player,'dacoit',function(data11){
assign_dacoit();
});
}else{
return;
}
});
}


function assign_players(game,callback){
assign_mafias(game,function(action){
if(action == 'again'){
assign_mafias(game);
}else{
return;
}
});
var c_res = assign_citizens(game);


callback('done');
}


function add_game_player(game,player,try_count){
var roles = ['mafia','citizen','healer','detective','dacoit'];
var num_a = get_random(roles.length);
try_count = try_count+1;
var set_role = "none";
var role_name = 'none';
var role_count = 0;
var result1 = games.find({name:game});
result1.on('complete',function(err,data12){
console.log(err+'v'+data12);
var game_users = data12[0].users;
console.log('role: '+roles[num_a]);
var new_user = new Array();
if(roles[num_a] == 'mafia'){
if(data12[0].mafias_count < 3){
set_role = 'mafia';
role_name = 'mafias_count';
role_count = data12[0].mafias_count+1;
var user_json = {'name':player,'role':set_role,'status':'alive'};
game_users.push(user_json);
var result2 = games.update({name:game},{$set:{users:game_users,mafias_count:role_count}});
result2.on('complete',function(err,docs){
console.log(docs);
});
}else{
//if(try_count < 15){
add_game_player(game,player,try_count);
/*}else{
return;
}
*/
}
}else if(roles[num_a] == 'citizen'){
if(data12[0].citizens_count < 3){
set_role = 'citizen';
role_name = 'citizens_count';
role_count = data12[0].citizens_count+1;
var user_json = {'name':player,'role':set_role,'status':'alive'};
game_users.push(user_json);
var result2 = games.update({name:game},{$set:{users:game_users,citizens_count:role_count}});
result2.on('complete',function(err,docs){
console.log(docs);
});
}
else{
//if(try_count < 15){
add_game_player(game,player,try_count);
/*}else{
return;
}
*/
}
}else if(roles[num_a] == 'healer'){
if(data12[0].healer_count < 1){
set_role = 'healer';
role_name = 'healer_count';
role_count = data12[0].healer_count+1;
var user_json = {'name':player,'role':set_role,'status':'alive'};
game_users.push(user_json);
var result2 = games.update({name:game},{$set:{users:game_users,healer_count:role_count}});
result2.on('complete',function(err,docs){
console.log(docs);
});
}else{
//if(try_count < 15){
add_game_player(game,player,try_count);
/*}else{
return;
}
*/
}
}else if(roles[num_a] == 'detective'){
if(data12[0].detective_count < 1){
set_role = 'detective';
role_name = 'detective_count';
role_count = data12[0].detective_count+1;
var user_json = {'name':player,'role':set_role,'status':'alive'};
game_users.push(user_json);
var result2 = games.update({name:game},{$set:{users:game_users,detective_count:role_count}});
result2.on('complete',function(err,docs){
console.log(docs);
});
}else{
//if(try_count < 15){
add_game_player(game,player,try_count);
/*}else{
return;
}
*/
}
}else if(roles[num_a] == 'dacoit'){
if(data12[0].dacoit_count < 1){
set_role = 'dacoit';
role_name = 'dacoit_count';
role_count = data12[0].dacoit_count+1;
var user_json = {'name':player,'role':set_role,'status':'alive'};
game_users.push(user_json);
var result2 = games.update({name:game},{$set:{users:game_users,dacoit_count:role_count}});
result2.on('complete',function(err,docs){
console.log(docs);
});
}else{
//if(try_count < 15){
add_game_player(game,player,try_count);
/*}else{
return;
}
*/
}
}else{
//if(try_count < 15){
add_game_player(game,player,try_count);
/*}else{
return;
}
*/
}

});
}

module.exports = {


add_game : function(name,user,callback){
console.log('request');
var roles = ['mafia','citizen','healer','detective','dacoit'];
var num1 = get_random(5);
var role1 = roles[num1];
var role_count = 0;
var mafia_answers = new Array();
var game_users = new Array();
var user_json = {'name':user,'role':role1,'status':'alive'};
game_users.push(user_json);
if(role1 == 'mafia'){
var result12 = games.insert({name:name,users:game_users,mafias_count:1,citizens_count:0,detective_count:0,dacoit_count:0,healer_count:0,mafia_answers:mafia_answers});
}else if(role1 == 'citizen'){
var result12 = games.insert({name:name,users:game_users,mafias_count:0,citizens_count:1,detective_count:0,dacoit_count:0,healer_count:0,mafia_answers:mafia_answers});
}else if(role1 == 'healer_count'){
var result12 = games.insert({name:name,users:game_users,mafias_count:0,citizens_count:0,detective_count:0,dacoit_count:0,healer_count:1,mafia_answers:mafia_answers});
}else if(role1 == 'detective'){
var result12 = games.insert({name:name,users:game_users,mafias_count:0,citizens_count:0,detective_count:1,dacoit_count:0,healer_count:0,mafia_answers:mafia_answers});
}else if(role1 == 'dacoit'){
var result12 = games.insert({name:name,users:game_users,mafias_count:0,citizens_count:0,detective_count:0,dacoit_count:1,healer_count:0,mafia_answers:mafia_answers});
}
//var result12 = games.insert({name:name,users:game_users,mafias_count:0,citizens_count:0,detective_count:0,dacoit_count:0,healer_count:0});
result12.on('complete',function(err,docs){
callback(docs);
});
},


add_player_to_game : function(game,player_name,callback){
add_game_player(game,player_name);
},

get_live_games : function(callback){
console.log('request');
var result1 = games.find({});
result1.on('complete',function(err,docs){
callback(docs);
});
},

add_nick : function(name,callback){
console.log('add nick');
var result112 = users.insert({name:name});
result112.on('complete',function(err,docs){
callback(docs);
});
},


get_game_id_from_name : function(name,docs){
var game1 = games.find({name:name});
game1.on('complete',function(err,docs){
callback(docs);
});
},



get_game_players : function(name,callback){
var result113 = games.find({name:name});
result113.on('complete',function(err,docs){
callback(docs);
});
},

get_game_mafias : function(name,callback){
var result112 = games.find({name:name});
result112.on('complete',function(err,docs){
callback(docs);
});
},


get_player_role : function(game,player,callback){
var role;
var result1 = games.find({name:game},{users:{$elemMatch : {name:/^player$/}}});
result1.on('complete',function(err,docs){
docs[0].users.forEach(function(element,index){
if(docs[0].users[index].name == player){
role = docs[0].users[index].role;
}
});
callback(role);
});
},

add_message : function(game,player_name,message,role,callback){
var result111 = messages.insert({game:game,player_name:player_name,message:message,role:role});
result111.on('complete',function(err,docs){
callback(docs);
});
},

get_mafia_messages : function(game,callback){
var result111 = messages.find({game:game,role:'mafia'});
result111.on('complete',function(err,docs){
callback(docs);
});
},

get_citizen_messages : function(game,callback){
var result111 = messages.find({game:game,role:'citizen'});
result111.on('complete',function(err,docs){
callback(docs);
});
},

get_citizen_messages : function(){

},


add_mafia_answers : function(game,answer,callback){
var result112 = games.find({name:game});
result112.on('complete',function(err,docs1){
var answers = docs1[0].answers;
answers.push(answer);
var result121 = games.update({name:game},{$set:{mafia_answers:answers}});
resultl21.on('complete',function(err,docs){
callback(docs);
});
});
},

add_healer_answer : function(game,answer,callback){
var result111 = games.update({name:game},{$set:{healer_answer:answer}});
result111.on('complete',function(err,docs){
callback(docs);
});
},

kill_person : function(game,player,callback){
var result111 = games.update({game:game},{$set:{role:'dead'}});
result111.on('complete',function(err,docs){
callback(docs);
});
},

has_role : function(game,player,callback){
var role = 'none';
var game12 = games.find({name:game},{users:{$elemMatch:{name:/^player$/}}});
game12.on('complete',function(err,docs){
docs[0].users.forEach(function(element,index){
if(docs[0].users[index].name == player){
role = docs[0].users[index].role;
}
});
callback(role);
});
},

is_this_mafia : function(game,player,callback){
var res1 = games.find({name:game});
res1.on('complete',function(err1,docs1){
docs1[0].users.forEach(function(){

});
});
},

is_game_ready : function(game,callback){
var result2 = games.find({name:game});
result2.on('complete',function(err1,docs1){
if(docs1[0].users.length == 9){
callback('game ready');
}else{
callback('game not ready');
}
});
},


add_mafia_answer : function(game,answer,player,callback){
var mafia_answers = new Array();
var answer_item = {name:player,answer:answer};
var result3 = games.find({name:game});
result3.on('complete',function(err,docs){
if(docs[0].mafia_answers.length < 3){

mafia_answers = docs[0].mafia_answers;
mafia_answers.push(answer_item);
var result4 = games.update({name:game},{$set:{mafia_answers:mafia_answers}});
result4.on('complete',function(err1,docs1){
callback(docs);
});
}
});
},


mafia_answer_result : function(answers,callback){
var count1 = 0;
var count2 = 0;
var count3 = 0;
var count_result = "";
answers.forEach(function(element,index){
if(answers[index].answer == answers[0]){
count1 = count1+1;
}else if(answers[index].answer == answers[1]){
count2 = count2+1;
}else if(answers[index].answer == answers[2]){
count3 = count3+1;
}
});
if(count1 > 1){
count_result = answers[0];
}else if(count2 > 1){
count_result = answers[1];
}else if(count3 > 1){
count_result = answers[2];
}else{
count_result = 'no result';
}
callback(count_result);
},

get_current_role : function(game,user,callback){
console.log(game);
var result111 = games.find({name:game});
var current_role = "";
result111.on('complete',function(err,docs){
docs[0].users.forEach(function(element,index){
if(docs[0].users[index].name == user){
current_role = docs[0].users[index].role;
}
});
callback(current_role);
});
},

has_mafia_added_answer : function(){
var result111 = games.find({});
},


kill_person : function(game,player,status,callback){
var result111 = games.update({"users.name":player_name},{$set:{"users.$.status":status}});
result111.on('complete',function(err,docs){
callback(docs);
});
},

assign_mafias : assign_mafias,
assign_players : assign_players,
set_player_role : set_player_role,
get_game_info : get_game_info


}